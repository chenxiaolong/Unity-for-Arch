# Maintainer: Xiao-Long Chen <chenxiaolong@cxl.epac.to>

_UBUNTU=true # Using Ubuntu patches?

pkgname=unity
pkgver=6.12.0
_actual_ver="${pkgver}"
_extra_ver="daily13.01.25.1"
pkgrel=100

if [ "${_UBUNTU}" == true ]; then
  _ubuntu_rel=0ubuntu1
  pkgver="${_actual_ver}.${_extra_ver}"
  pkgrel="${pkgrel}.${_ubuntu_rel}"
fi

pkgdesc="A desktop experience designed for efficiency of space and interaction"
arch=('i686' 'x86_64')
url="https://launchpad.net/unity"
license=('GPL')
depends=('bamf' 'boost' 'compiz-ubuntu>=0.9.8.4' 'clutter-gtk' 'gjs' 'gnome-desktop' 'gnome-session-ubuntu' 'libgnomeui' 'libindicator' 'libnotify' 'libunique' 'libunity' 'libunity-misc' 'nux' 'unity-asset-pool' 'vala' 'xorg-server>=1.12.0-100' 'libindicator3' 'libxfixes-ubuntu' 'gnome-screensaver')
makedepends=('cmake' 'intltool' 'pkg-config' 'doxygen' 'python2-distribute')
groups=('unity')
provides=("unity-core=${_actual_ver}")
conflicts=('unity-core')

install=unity.install
source=("https://launchpad.net/ubuntu/+archive/primary/+files/unity_${_actual_ver}${_extra_ver}.orig.tar.gz"
        "https://launchpad.net/ubuntu/+archive/primary/+files/unity_${_actual_ver}${_extra_ver}-${_ubuntu_rel}.diff.gz"
        #"http://unity.xe-xe.org/files/unity-i18n-launchpad-export-20120902.tar.gz" # Snapshot of translations from Launchpad as of 2012-09-02
        "unity-i18n-launchpad-export-20130120.tar.gz::http://ubuntuone.com/6GxarcWdEEk88kf4m3f7ZZ" # Snapshot of translations from Launchpad as of 2013-01-20
        '0001_Remove_gtest.patch'
        'launcher_bfb.png'
        'archlinux_branding.patch'
        'unity-migrate-dconf-path.desktop'
        '10_unity.gschema.override')
sha512sums=('51516e1bd32ca386cc556f22e66c66019a6dbe7a267c8b05b64e7921be178e25c54187e81502734725190846f4e438176b8e254856a712a6bb6e0174e16c4756'
            'c78601781d35cc0eda40fb79696e18380209b1dec50214374624661d34313527042c6b4c1fcad1c87b39b9b503a505d3cc0a8bf9c2e69f19b74942ab017ec573'
            'a70f14aa85b37a2a009791a3c0f9971e571c273ab94d7115f3fca449bc4b0e4a102bd9ca21e6dbbda67e3f1f858b0212e59fbb86c67ce35682b42d73a7239191'
            'd4f9bc2078df390003b8749955ff22be4538e79cb57efac8a29b98ee1567eb7787e61c1f577884e7ae801b7eeb3207370a1cec1fdce86cb217da50f981374fad'
            '9f5469c0300d0c33e26db670771803efd3d821e82689fbb1391a31b8fd0e280a12ea010fe6f32a702a5d1797918d416c8adabfccf6049e43b496ebb6dbe2c054'
            '2043f51dcf65062a760fa47dd4c847a9c96d6b285400e103f46715839150e76757e85f50ca1be85f66434f8c4e011129620794a53c46ddd23e0d92c282bf0acf'
            '8eb535adc7aefd95c0ccfdd35525b4be764c4377ae5fc6002ad6ef6fd84b733c9054f8228083ce50eac1f970fdc1ef987ad1eb47813e7621b481ec3f490a9df7'
            '872c48f85350d2d815418afab340946f85ec1f9f3e1ab748fc1199df342df52642447736a5b783fb17eb324a961bbf8badc4e8401512e7182e4ff2e25b53d3a1')

build() {
  cd "${srcdir}/${pkgname}-${_actual_ver}${_extra_ver}"

  # Arch Linux branding: "Ubuntu Desktop" -> "Arch Linux Desktop"
  # (thanks to qiuwei!)
  patch -p1 -i "${srcdir}/archlinux_branding.patch"

  # Apply Ubuntu patches
  patch -p1 -i "${srcdir}/unity_${_actual_ver}${_extra_ver}-${_ubuntu_rel}.diff"
  for i in $(cat debian/patches/series | grep -v '#'); do
    patch -p1 -i "debian/patches/${i}"
  done

  # Disable gtest: depends highly on Ubuntu's packaging of gtest
  patch -p1 -i "${srcdir}/0001_Remove_gtest.patch"

  # Cannot find gmodule
  CXXFLAGS="${CXXFLAGS} $(pkg-config --cflags --libs gmodule-2.0)"
  CFLAGS="${CFLAGS} $(pkg-config --cflags --libs gmodule-2.0)"

  # Link against pthread
  LDFLAGS="${LDFLAGS} -lpthread"

  # Fix pkgconfig
  #sed -i -e 's/\${libdir}/@LIBDIR@/g' -e 's/\${includedir}/@INCLUDEDIR@/g' UnityCore/unity-core.pc.cmake

  # Install translations from Launchpad
  pushd po
  rm LINGUAS && touch LINGUAS # Recreate LINGUAS (list of languages) file
  for i in "${srcdir}"/po/*.po; do
    _NEWFILE=${i##*/} # Strip path
    _NEWFILE=${_NEWFILE#*-} # Strip 'unity-'
    cp "${i}" "${_NEWFILE}" # Copy new translation
    echo "${_NEWFILE%.*}" >> LINGUAS # Add translation
  done
  cp "${srcdir}/po/unity.pot" unity.pot
  popd

  # Disable '-Werror'
  #sed -i 's/[ ]*-Werror[ ]*//g' CMakeLists.txt services/CMakeLists.txt

  [[ -d build ]] && rm -rvf build/
  mkdir build/ && cd build/

  cmake \
    -DCOMPIZ_BUILD_WITH_RPATH=FALSE \
    -DCOMPIZ_PACKAGING_ENABLED=TRUE \
    -DCOMPIZ_PLUGIN_INSTALL_TYPE=package \
    -DCMAKE_BUILD_TYPE=Release \
    -DCMAKE_INSTALL_PREFIX=/usr \
    -DUSE_GSETTINGS=TRUE \
    -Duse_pch=OFF \
    ..

  #MAKEFLAGS="-j1"
  make ${MAKEFLAGS}

  # Make sure that the GSettings schema files were created
  pushd generated/glib-2.0/schemas/
  if \
    [ ! -f org.compiz.networkarearegion.gschema.xml ] || \
    [ ! -f org.compiz.unitydialog.gschema.xml ] || \
    [ ! -f org.compiz.unitymtgrabhandles.gschema.xml ] ||
    [ ! -f org.compiz.unityshell.gschema.xml ]; then
    make compiz_gsettings_compile_local
  fi
  popd

  # Build autopilot tests
  pushd ../tests/autopilot/
  python2 setup.py build
  popd
}

package() {
  cd "${srcdir}/${pkgname}-${_actual_ver}${_extra_ver}/build"
  make DESTDIR="${pkgdir}/" install

  # Install autopilot and autopilot tests
  pushd ../tests/autopilot/
  python2 setup.py install --root "${pkgdir}" --skip-build --optimize=1
  popd

  # Install dconf path migration stuff
  install -dm755 "${pkgdir}/etc/xdg/autostart/"
  install -m644 "${srcdir}/unity-migrate-dconf-path.desktop" \
    "${pkgdir}/etc/xdg/autostart/"
  install -m755 ../tools/migration-scripts/01_unity_change_dconf_path \
    "${pkgdir}/usr/lib/unity/"

  # Install profile convert files
  install -dm755 "${pkgdir}/usr/lib/compiz/migration/"
  install -m644 ../tools/convert-files/* "${pkgdir}/usr/lib/compiz/migration/"

  # Taken from Ubuntu source package's debian/rules file
  find "${pkgdir}/usr/lib" -name \*.*a -exec rm {} \;
  rm -vf "${pkgdir}/usr/share/compiz/networkarearegion.xml"
  rm -vf "${pkgdir}/usr/lib/compiz/libnetworkarearegion.so"
  rm -vf "${pkgdir}/usr/share/compiz/unitydialog.xml"
  rm -vf "${pkgdir}/usr/lib/compiz/libunitydialog.so"

  # Fix Python 2 scripts
  sed -i 's|^\(#!.*python$\)|\12|g' \
    "${pkgdir}/usr/bin/unity" \
    "${pkgdir}/usr/lib/unity/makebootchart.py"

  # Arch Linux logo
  install -m644 "${srcdir}/launcher_bfb.png" \
    "${pkgdir}/usr/share/unity/6/launcher_bfb.png"

  # Check for missing GSettings schemas
  pushd "${pkgdir}/usr/share/glib-2.0/schemas/"
  if \
    [ ! -f org.compiz.networkarearegion.gschema.xml ] || \
    [ ! -f org.compiz.unitydialog.gschema.xml ] || \
    [ ! -f org.compiz.unitymtgrabhandles.gschema.xml ] || \
    [ ! -f org.compiz.unityshell.gschema.xml ]; then
    error "GSettings schemas didn't get installed"'!'
    error "Please tar and upload the src/ directory and report a bug."
    exit 1
  fi
  popd

  # Change window dragging key back to Alt. Super conflicts with Unity's other
  # hotkeys.
  install -m644 "${srcdir}/10_unity.gschema.override" \
    "${pkgdir}/usr/share/glib-2.0/schemas/"

  # GNOME screensaver autostart file
  install -dm755 "${pkgdir}/etc/xdg/autostart/"
  sed \
    -e '/AutostartCondition/d' \
    -e 's/OnlyShowIn=.*/OnlyShowIn=Unity;/g' \
    < /etc/xdg/autostart/gnome-screensaver.desktop \
    > "${pkgdir}/etc/xdg/autostart/gnome-screensaver-unity.desktop"
}

# vim:set ts=2 sw=2 et:
